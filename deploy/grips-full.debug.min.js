/* grips (c) 2012 Kyle Simpson | http://getify.mit-license.org/ */
;Object.keys||(Object.keys=function(t){var n,r=[];for(n in t)t.hasOwnProperty(n)&&r.push(n);return r}),Object.create||(Object.create=function(t){function n(){}return n.prototype=t,new n}),Object.prototype.toJSON||(Object.prototype.toJSON=function(){function t(e){for(var t=0;t<r.length;t++)if(r[t]===e)return!0;return!1}function n(e){function i(e){if(typeof e=="object"){if(e!==null){if(Date===e.constructor||Number===e.constructor||Boolean===e.constructor||String===e.constructor||RegExp===e.constructor)return e;if(!t(e))return n(e)}return null}return e}var s,o,u;if(Object.prototype.toString.call(e)==="[object Array]"){r.push(e),o=[];for(s=0;s<e.length;s++)o.push(i(e[s]));return r.pop(),o}if(typeof e=="object"){if(e!==null){if(Date===e.constructor||Number===e.constructor||String===e.constructor||Boolean===e.constructor||RegExp===e.constructor)return e;if(!t(e)){r.push(e),o={};for(s in e)e.hasOwnProperty(s)&&(u=i(e[s]),u!==null&&(o[s]=u));return r.pop(),o}}return null}return e}var r=[],i;return i=n(this),r=[],i},Object.defineProperty&&Object.defineProperty(Object.prototype,"toJSON",{enumerable:!1})),function(t){function r(){function i(){}function s(){var e=t.grips;return t.grips=n,e}function o(e){e in y||(y[e]={collection:"",extend:null,partials:{}})}function u(e,t){o(e),y[e].extend=t}function a(e){var t,n,r;if(typeof e=="object"){if(e===null)return e;if(Object.prototype.toString.call(e)==="[object Array]"){n=[];for(t=0;t<e.length;t++)typeof e[t]=="object"?r=deepClone2(e[t]):r=e[t],n.push(r)}else{e instanceof i?n=new i:n={};for(t in e)e.hasOwnProperty(t)&&(typeof (e[t]==="object")?r=a(e[t]):r=e[t],n[t]=r)}}else n=e;return n}function f(t,n,r,i){return r="["+t+"] "+r,i&&(r+="; "+i.toString()),new e(r,n,i?i.stack:null)}function l(t,n,r){var i=n.match(/^(.+)#/);i&&(i=i[1]);if(!i)throw new e("Missing collection ID: "+n)||b;o(i),y[i].partials[n.replace(/^.*#/,"#")]=function(){var n,s;try{s=t.apply(g,arguments)}catch(o){throw n=f(i,r,"Unexpected error",o),n.stack=o.stack,n}if(s instanceof Error)throw s;return s}}function c(e,t){var n="",r,i;t=t!==!1;if(Object.prototype.toString.call(e)==="[object Array]")for(r=0;r<e.length;r++)n+=p(e[r],null,t);else if(typeof e=="object")for(i in e)e.hasOwnProperty(i)&&(n+=p(e[i],i,t));return n}function h(t,n){if(!n)throw new e("Missing collection ID")||b;return p(t,n,!1)}function p(e,t,n){var r;n=n!==!1;try{if(g.tokenizer.process(e,t))return g.parser.end(),g.generator.process(n)}catch(i){throw i instanceof g.tokenizer.TokenizerError||i instanceof g.parser.ParserError?i:(r=f(t,null,"Unexpected compilation error",i),r.stack=i.stack,r)}return!1}function d(e){var n,r;"document"in t?(n=document.createElement("script"),n.text=e,r=document.getElementsByTagName("script")[0],r.parentNode.insertBefore(n,r)):(n=new Function(e),n.call(t))}function v(e,t){o(e),d(t)}function m(t,n,r){if(!t)return"";var i,s,o,u,a=[],f=!1,l=!1;i=t.match(/^(.+)#/),i&&(i=i[1],f=!0);if(!f&&w.length>0)i=w[w.length-1];else if(!f||w.length>0&&w[w.length-1]===i){if(!i)throw new e("Required collection ID missing: "+t)||b}else w.push(i),l=!0;if(i in y){t=t.replace(/^(.+)#/,"#"),u=i+t,E.push(u);for(o=0;o<E.length-1;o++)if(E[o]===u)throw new e("Recursive template include: "+u)||b;f?a.push(i):a=a.concat(w);if(!(t in y[i].partials)&&y[i].extend){u=y[i].extend;while(u&&u in y)a.push(u),u=y[u].extend}for(o=0;o<a.length;o++)if(t in y[a[o]].partials){s=y[a[o]].partials[t](n,r);break}}if(s)return E.pop(),l&&w.pop(),s;throw new e("["+t+"] Template not found")||b}var e=function(){function n(){}function r(e,r,i){var s=this===t?new n:this;return s.message=e,s.ref=r,s.stack=i,s}return n.prototype=r.prototype=Object.create(ReferenceError.prototype),r.prototype.constructor=r,r.prototype.toString=function(){var t="TemplateError: "+this.message;return this.ref&&(t+="; "+JSON.stringify(this.ref)),this.stack&&(t+="\n"+this.stack),t},r}(),g,y={},b=new Error("Unknown error"),w=[],E=[];return g={extend:u,cloneObj:a,error:f,definePartial:l,compile:c,compileChunk:h,compileCollection:p,initialize:d,initializeCollection:v,render:m,TemplateError:e,noConflict:s,sandbox:r,RangeLiteralHash:i},g}var n=t.grips;t.grips=r()}(this),function(t){function n(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t])}function i(){var e;do e=Math.floor(Math.random()*1e9);while(e in u);return e}function s(e,s){function a(e){var t,n,r,i;for(r=0;r<e.length;r++)if(e[r].type===S){t=n=r;for(i=t+1;i<e.length;i++){n=i;if(e[i].type!==S){n=i-1;break}}if(n>t){for(i=t+1;i<=n;i++)e[t].val+=e[i].val;e.splice(t+1,n-t)}else r=i}return e}function y(e){for(var t=0;t<e.length;t++)e[t].type===S&&(e[t].val=e[t].val.replace(/\\\\/g,"\\"));return e}function k(){var i,u;F&&(q=new n({type:null,val:F,pos:P}),F.match(/^\s+$/)?q.type=x:q.type=S,o.push(q));if(B){u=e.substring(0,D-B[0].length);if(!!u&&!u.match(T)){o.push(new n({type:S,val:B[0],pos:D-B[0].length}));return}if(B[0]==="{$}")o.push(new n({type:h,val:B[0],pos:D-B[0].length}));else{if(B[0]!=="{$")return new r("Unrecognized token",new n({type:TOKEN_TAG_UNKNOWN,val:B[0],pos:D-B[0].length}))||C;q=new n({type:f,val:B[0],pos:D-B[0].length}),o.push(q);if(!(D<e.length-1&&(B=e.substr(D).match(/^(?:[:+=*\/%]|(?:define|extend|insert|print|partial|loop|comment|raw)\b)/))))return new t.parser.ParserError("Expected Tag type-signifier",new n({type:S,val:e.substr(D,1),pos:D}))||C;o.push(new n({type:p,val:B[0],pos:D})),D+=B[0].length}}o=o.concat(i=y(a(o.splice(H-o.length)))),I=t.parser.nodify(i,s),H=o.length}function L(){var e,i;if(F){if(i=F.match(/[^a-z0-9_$\s]/i))return new r("Unrecognized token",new n({type:S,val:i[0],pos:P+i.index}))||C;o.push(new n({type:S,val:F,pos:P}))}if(B)if(B[0]==="$}")o.push(new n({type:l,val:B[0],pos:D-B[0].length}));else if(B[0]==="}")o.push(new n({type:c,val:B[0],pos:D-B[0].length}));else{if(B[0].match(/^\s+$/)){o.push(new n({type:x,val:B[0],pos:D-B[0].length}));return}if(B[0].match(/^["']$/))q=new n({type:0,val:B[0],pos:D-B[0].length}),B[0]==='"'?q.type=w:q.type=b,o.push(q),N[t.parser.LITERAL]=new RegExp(B[0],"g"),N[t.parser.LITERAL].lastIndex=0;else if(B[0].match(/^(?:\.\.)|[:=?\(\)\[\],\-.!]$/))o.push(new n({type:E,val:B[0],pos:D-B[0].length}));else if(B[0]==="|")o.push(new n({type:m,val:B[0],pos:D-B[0].length}));else{if(B[0]!=="@"){o.push(new n({type:S,val:B[0],pos:D-B[0].length}));return}o.push(new n({type:g,val:B[0],pos:D-B[0].length}))}}o=o.concat(e=y(a(o.splice(H-o.length)))),I=t.parser.nodify(e,s),H=o.length}function A(){var e,r;o[o.length-1].type!=S&&o.push(new n({type:S,val:"",pos:P})),F&&(o[o.length-1].val+=F),B&&(r=o[o.length-1].val,!r||r.match(T)?(o.push(new n({type:v,val:B[0],pos:D-B[0].length})),o=o.concat(e=y(a(o.splice(H-o.length)))),I=t.parser.nodify(e,s),H=o.length):(r&&!r.match(T)&&(o[o.length-1].val=o[o.length-1].val.substr(0,o[o.length-1].val.length-1)),o[o.length-1].val+=B[0]))}function O(){var e,r;if(B){r=o[o.length-1].val;if(!r||r.match(T))o.push(new n({type:d,val:B[0],pos:D-B[0].length})),o=o.concat(e=y(a(o.splice(H-o.length)))),I=t.parser.nodify(e,s),H=o.length}}function M(){var e,r;o[o.length-1].type!=S&&o.push(new n({type:S,val:"",pos:P})),F&&(o[o.length-1].val+=F),B&&(r=o[o.length-1].val,!r||r.match(T)?(o.push(new n({type:B[0]==='"'?w:b,val:B[0],pos:D-B[0].length})),o=o.concat(e=y(a(o.splice(H-o.length)))),I=t.parser.nodify(e,s),H=o.length,N[t.parser.STRING_LITERAL]=null):(r&&!r.match(T)&&(o[o.length-1].val=o[o.length-1].val.substr(0,o[o.length-1].val.length-1)),o[o.length-1].val+=B[0]))}var _,D=0,P=0,H=o.length,B,j,F,I,q,R,U=[k,L,A,O,M];s||(s=i(),u[s]=!0,s="chunk_"+s);while((!I||I===!0)&&D<e.length){I=null,j=t.parser.state;if(j===t.parser.INVALID)break;_=N[j];if(!_){I=new t.parser.ParserError("Invalid parser state")||C;break}F="",_.lastIndex=D,B=_.exec(e);if(B)P=D,D=_.lastIndex,P<D-B[0].length&&(F=e.substring(P,D-B[0].length));else{P=D,D=e.length,F=e.substr(P);if(!F)break}R=U[j]();if(R&&R!==!0)break;if(I&&I!==!0)break}if(R instanceof r||R instanceof t.parser.ParserError)throw R;if(I instanceof r||I instanceof t.parser.ParserError)throw I;if(R instanceof Error)throw R;if(I instanceof Error)throw I;return!0}n.prototype.toString=function(){return"`"+this.val+"`; position: "+this.pos+"; token-type: "+this.type};var r=function(){function t(){}function n(e,n){var r=this===global?new t:this;return r.message=e,r.token=n,r}return t.prototype=n.prototype=Object.create(SyntaxError.prototype),n.prototype.constructor=n,n.prototype.toString=function(){return"TokenizerError: "+this.message+"; "+this.token.toString()},n}(),o=[],u={},a=0,f=0,l=1,c=2,h=3,p=4,d=5,v=6,m=7,g=8,y=9,b=10,w=11,E=12,S=13,x=14,T=/(?:[^\\]|(?:^|[^\\])(?:\\\\)+)$/,N=[/\{\$\}|\{\$/g,/\$\}|\}|(?:\.\.)|["':=@\|?\(\)\[\],\-.!]|\s+/g,/%\$\}/g,/\/\$\}/g],C=new Error("Unknown error");t.tokenizer={OPEN:f,SIMPLE_CLOSE:l,BLOCK_HEAD_CLOSE:c,BLOCK_FOOTER:h,SIGNIFIER:p,COMMENT_CLOSE:d,RAW_CLOSE:v,PIPE:m,AT:g,STRING_LITERAL:y,SINGLE_QUOTE:b,DOUBLE_QUOTE:w,OPERATOR:E,GENERAL:S,WHITESPACE:x,process:s,TokenizerError:r,Token:n}}(this.grips),function(t){function n(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t])}function i(e,i){function s(e){if(e.type===t.tokenizer.OPEN)c=new n({parent:null,type:null,token:e,def:[],children:[],complete:!1}),d?(c.parent=d,d.children.push(c)):(delete c.parent,p.push(c)),d=c,X.state=y;else if(e.type===t.tokenizer.GENERAL)c=new n({parent:null,type:x,token:e,val:e.val}),d?(c.parent=d,d.children.push(c)):(delete c.parent,p.push(c));else if(d&&e.type===t.tokenizer.WHITESPACE)c=new n({parent:d,type:x,token:e,val:e.val}),d.children.push(c);else if(e.type===t.tokenizer.BLOCK_FOOTER){if(!d||d.close_header!==t.tokenizer.BLOCK_HEAD_CLOSE)return X.state=S,new r("Unexpected Tag",e)||V;d.complete=!0,d=d.parent}}function o(e){function s(){if(d.type===k||d.type===C||d.type===L){c=new n({parent:d,type:null,token:null,def:[]});if(!d.main_expr&&d.type===L)d.main_expr=c,c.type=_;else if(d.type===k||d.type===C){if(!!d.main_expr)return X.state=S,new r("Unexpected token",e)||V;d.main_expr=c,c.type=_,d.type===C&&(c.collection_id=i)}else c.type=D;d.def.push(c),d=c}}if(e.type===t.tokenizer.SIGNIFIER){if(!d||d.type!=null)return X.state=S,new t.tokenizer.TokenizerError("Unexpected token",e)||V;e.val.match(/^(?:\:|define)$/)?d.type=N:e.val.match(/^(?:\+|extend)$/)?d.type=T:e.val.match(/^(?:\=|insert|print)$/)?d.type=k:e.val.match(/^partial$/)?d.type=C:e.val.match(/^(?:\*|loop)$/)?d.type=L:e.val.match(/^(?:\%|raw)$/)?d.type=A:e.val.match(/^(?:\/|comment)$/)&&(d.type=O),d.type===T||d.type===k?(d.close_header=t.tokenizer.SIMPLE_CLOSE,delete d.children):d.type===C?d.close_header=t.tokenizer.SIMPLE_CLOSE:d.type===N||d.type===L?d.close_header=t.tokenizer.BLOCK_HEAD_CLOSE:d.type===A?(d.val="",X.state=b,delete d.def,delete d.children):d.type===O&&(d.val="",X.state=w,delete d.def,delete d.children);if(!d.parent&&d.type!==T&&d.type!==N&&d.type!==O)return X.state=S,new r("Unexpected Tag",d)||V}else if(e.type===t.tokenizer.WHITESPACE){if(d){if(d.type!==T&&d.type!==N&&d.type!==C&&d.type!==k&&d.type!==L&&d.type!==D&&d.type!==_)return X.state=S,new t.tokenizer.TokenizerError("Unexpected token",e)||V;d.def.length>0&&d.def.push(new n({parent:d,type:U,token:e}))}}else if(e.type===t.tokenizer.AT){if(!d||d.type!==k||d.def.length!==0)return X.state=S,new t.tokenizer.TokenizerError("Unexpected token",e)||V;d.type=C}else if(e.type===t.tokenizer.SINGLE_QUOTE||e.type===t.tokenizer.DOUBLE_QUOTE){if(!d||d.type!==T&&d.type!==N&&d.type!==C&&d.type!==D&&d.type!==_)return X.state=S,new t.tokenizer.TokenizerError("Unexpected token",e)||V;X.state=E,c=new n({parent:d,type:null,token:e,val:"",delimiter:e.val});if(d.type===N||d.type===T){if(!!d.id)return X.state=S,new t.tokenizer.TokenizerError("Unexpected token",e)||V;d.id=c,c.type=M,d.type===N&&(c.collection_id=i)}else if(d.type===C){if(!!d.main_expr)return X.state=S,new t.tokenizer.TokenizerError("Unexpected token",e)||V;d.main_expr=c,c.type=M,c.collection_id=i}else c.type=I;d.def.push(c),d=c}else if(e.type===t.tokenizer.OPERATOR){if(!d)return X.state=S,new t.tokenizer.TokenizerError("Unexpected token",e)||V;e.val.match(/[\(\[]/)&&s();if(d.type!==D&&d.type!==_)return X.state=S,new t.tokenizer.TokenizerError("Unexpected token",e)||V;d.token||(d.token=e);if(e.val==="-"&&d.def.length>0&&d.def[d.def.length-1].type!==U&&(d.def[d.def.length-1].type!==z||!d.def[d.def.length-1].val.match(/(?:\.\.)|\[/)))return new t.tokenizer.TokenizerError("Unexpected token",e)||V;d.def.push(new n({parent:d,type:z,token:e,val:e.val}))}else if(e.type===t.tokenizer.PIPE){if(!d)return X.state=S,new t.tokenizer.TokenizerError("Unexpected token",e)||V;if(d.type===D||d.type===_)d=d.parent;if(!d.id&&(d.type===N||d.type===T))return X.state=S,new r("Expected #id for Tag",d)||V;if(!(d.type===N||d.type===L||d.type===C&&!d.context_expr))return X.state=S,new t.tokenizer.TokenizerError("Unexpected token",e)||V;c=new n({parent:d,type:D,token:null,def:[]}),d.type===C&&(d.context_expr=c),d.def.push(c),d=c}else if(e.type===t.tokenizer.SIMPLE_CLOSE){if(!d)return X.state=S,new t.tokenizer.TokenizerError("Unexpected token",e)||V;if(d.type===D||d.type===_)d=d.parent;if(!d.id&&d.type===T)return X.state=S,new r("Expected #id for Tag",d)||V;if(d.close_header!==t.tokenizer.SIMPLE_CLOSE)return X.state=S,new r("Unexpected Tag closure",e)||V;d.type===C&&!d.context_expr&&(c=new n({parent:d,type:D,token:null,def:[]}),c.def.push(new n({parent:c,type:x,token:null,val:"$"})),d.context_expr=c,d.def.push(c)),d.complete=!0,X.state=g,d=d.parent}else if(e.type===t.tokenizer.BLOCK_HEAD_CLOSE){if(!d)return X.state=S,new t.tokenizer.TokenizerError("Unexpected token",e)||V;if(d.type===D||d.type===_)d=d.parent;if(!d.id&&d.type===N)return X.state=S,new r("Expected #id for Tag",d)||V;if(d.close_header!==t.tokenizer.BLOCK_HEAD_CLOSE)return X.state=S,new r("Unexpected Tag closure",e)||V;X.state=g}else if(e.type===t.tokenizer.GENERAL){if(!d)return X.state=S,new r("Unexpected token",e)||V;s();if(d.type!==D&&d.type!==_)return X.state=S,new r("Unexpected token",e)||V;d.token||(d.token=e),e.val.match(/^\d+$/)&&d.def.length>0&&d.def[d.def.length-1].type===z&&d.def[d.def.length-1].val==="-"?d.def[d.def.length-1]=new n({parent:d,type:x,token:new t.tokenizer.Token({type:t.tokenizer.GENERAL,val:"-"+e.val,pos:e.pos-1}),val:"-"+e.val}):d.def.push(new n({parent:d,type:x,token:e,val:e.val}))}}function u(e){if(e.type===t.tokenizer.GENERAL)d.token.type!==t.tokenizer.GENERAL&&(d.token=e),d.val+=e.val;else{if(e.type!==t.tokenizer.RAW_CLOSE)return new r("Unexpected token",e)||V;d.complete=!0,d=d.parent,X.state=g}}function a(e){e.type===t.tokenizer.COMMENT_CLOSE&&(d=d.parent,d?d.children.pop():p.pop(),X.state=g)}function f(e){if(e.type===t.tokenizer.GENERAL)d.token.type!==t.tokenizer.GENERAL&&(d.token=e),d.val+=e.val;else{if(e.type!==t.tokenizer.SINGLE_QUOTE&&e.type!==t.tokenizer.DOUBLE_QUOTE||d.delimiter!==e.val)return new r("Unexpected token",e)||V;d=d.parent,X.state=y}}var l,c,h,m=[s,o,u,a,f];i!==v&&(v&&p.push(new n({type:W,close:v,complete:!0})),v=i,p.push(new n({type:W,start:i,complete:!0})));for(l=0;l<e.length;l++){if(X.state===S)return new r("Invalid parser state")||V;h=m[X.state](e[l]);if(h)return h}return!0}function s(){v&&p.push(new n({type:W,close:v,complete:!0})),v=null}function o(e){var t,n,r,i;for(r=0;r<e.length;r++)if(e[r].type===x){t=n=r;for(i=t+1;i<e.length;i++){n=i;if(e[i].type!==x){n--;break}}if(n>t){for(i=t+1;i<=n;i++)e[t].token.val+=e[i].token.val,e[t].val+=e[i].val;e.splice(t+1,n-t)}else r=i}return u(e)}function u(e){var t,n,r,i;for(r=0;r<e.length;r++)if(e[r].type===U){t=n=r;for(i=t+1;i<e.length;i++){n=i;if(e[i].type!==U){n--;break}}if(n>t){for(i=t+1;i<=n;i++)e[t].token.val+=e[i].token.val,e[t].val+=e[i].val;e.splice(t+1,n-t)}else r=i}return e}function a(e){var t=[],n=0,r=e.length-1;while(n<=r){e[n].type===U&&n++,e[r].type===U&&r--;if(!(n<r)||e[n].type!==U&&e[r].type!==U)break}return n<=r&&(t=e.slice(n,r+1)),t}function f(e){var t=[],n=0,r=e.length-1,i,s=0;while(n<r){e[n].type===U&&n++,e[r].type===U&&r--;if(n<r&&e[n].type!==U&&e[r].type!==U){if(e[n].type!==z||e[n].val!=="("||e[r].type!==z||e[r].val!==")")break;for(i=n+1;i<r;i++)if(e[i].type===z){e[i].val==="("?s++:e[i].val===")"&&s--;if(s<0)break}if(s!==0)break;n++,r--}}return n<=r&&(t=e.slice(n,r+1)),t}function l(e){for(var t=0;t<e.length;t++)e[t].type===z&&(e.splice(t,1),t--)}function c(e){function i(e){var t,n,r=[],i=!1;if(e.length<5)return!1;if(e[0].type!==z||e[0].val!=="[")return!1;r.push(e[0]);for(t=1;t<e.length;t++){if(e[t].type===U)continue;r.push(e[t]);if(e[t].type===z){if(e[t].val==="]")break;if(!e[t].val.match(/(?:\.\.)|[\-,]/))return!1;e[t].val.match(/(?:\.\.)|,/)&&(i=!0)}}return r.length<5||!i?!1:r}function s(e){function t(e,t,r){var i,s;e=f(e),i=new n({parent:u,type:t,token:e[0].token,def:e}),S=r(i);if(S)return S;for(s=0;s<i.def.length;s++)i.def[s].parent=i;return i}var r,i,s=[],o,u,a,l,c;if(e.length>0){for(r=0;r<e.length;r++){i=e[r];if(i.type===z&&i.val.match(/[?:]/)){if(i.val==="?"){if(!!u)return!1;u=new n({parent:null,type:j,token:e[0].token,def:[]}),a=t(s,F,p);if(a instanceof Error)throw a;c=new n({parent:u,type:B,token:null,def:[]}),o=new n({parent:c,type:I,token:null,val:"",delimiter:'"'}),c.def.push(o),s=[]}else if(i.val===":"){if(!u||!!l)return!1;l=t(s,B,g);if(l instanceof Error)throw l;s=[]}}else s.push(i)}if(s.length>0){if(!u)return!1;if(!l){l=t(s,B,g);if(l instanceof Error)throw l}else{c=t(s,B,g);if(c instanceof Error)throw c}s=[]}if(a&&l)return u.def.push(a,l,c),u}}function h(e){var n;if((n=e.val.match(/#/g))&&n.length>1)return new r("Unexpected extra #id",e);if(e.parent.type===N){if(!e.val)return new r("Expected #id",e)||V;if(n=e.val.match(/(#.*?)([^a-z0-9_\-$.]).*$/i))return new t.tokenizer.TokenizerError("Unexpected token",new t.tokenizer.Token({type:t.tokenizer.GENERAL,val:n[2],pos:e.token.pos+n.index+n[1].length}))||V;if(!e.val.match(/^#/))return new r("Unexpected text before #id",e)||V;e.val=e.collection_id+e.val}else if(e.parent.type===T){if(n=e.val.match(/#/))return new t.tokenizer.TokenizerError("Unexpected token",new t.tokenizer.Token({type:t.tokenizer.GENERAL,val:"#",pos:e.token.pos+n.index}))||V}else if(e.parent.type===C){if(!e.val)return new r("Expected #id",e)||V;if(n=e.val.match(/(#.*?)([^a-z0-9_\-$.]).*$/i))return new t.tokenizer.TokenizerError("Unexpected token",new t.tokenizer.Token({type:t.tokenizer.GENERAL,val:n[2],pos:e.token.pos+n.index+n[1].length}))||V}}function p(e){function n(e){while(e.parent&&(e=e.parent))if(e.type===t.parser.TAG_LOOP)return!0;return!1}function i(e){while(e.parent&&(e=e.parent))if(e.type===t.parser.MAIN_REF_EXPR||e.type===t.parser.ASSIGNMENT_EXPR)return e.type===t.parser.MAIN_REF_EXPR;return!1}var s,o,u,a,f=[];if(!(e.def&&e.def.length>0))return new r("Expected EXPR",e)||V;for(s=0;s<e.def.length;s++){if(e.def[s].type===U)continue;u=a,a=e.def[s];if(a.type===z){if(!a.val.match(/[.!\[\]\(\)]/))return new t.tokenizer.TokenizerError("Unexpected token",a.token)||V;if(u)if(u.type===z){if(a.val==="("&&!u.val.match(/[!\(\[]/))return new r("Invalid EXPR",a)||V;if(a.val==="!"&&!u.val.match(/[!\(]/))return new r("Invalid EXPR",a)||V;if(a.val.match(/[.\[\]\)]/)&&!u.val.match(/[\]\)]/))return new r("Invalid EXPR",a)||V}else{if(u.type===x&&!a.val.match(/[.\[\]\)]/))return new r("Invalid EXPR",a)||V;if(u.type===I&&!a.val.match(/[\]\)]/))return new r("Invalid EXPR",a)||V}else if(!a.val.match(/[!\(]/))return new r("Invalid EXPR",a)||V;if(a.val.match(/[\[\(]/))f.push(a.val);else if(a.val.match(/[\]\)]/)){if(!(f.length>0&&(f[f.length-1]==="["&&a.val==="]"||f[f.length-1]==="("&&a.val===")")))return new r("Unbalanced EXPR",a)||V;f.pop()}}else if(a.type===x){if(a.val.match(/^\d/)){if(!a.val.match(/^\d+$/))return new r("Invalid identifier in EXPR",a)||V;if(u&&(u.type!==z||!u.val.match(/[\(\[]/)))return new r("Unexpected number",a)||V}o=i(a);if(e.def.length===1&&a.val==="_"&&!o&&a.parent.parent.context_expr!==a.parent)return new r("Invalid identifier in EXPR",a)||V;if(a.val==="_"&&!(o&&n(a.parent.parent)||!o&&n(a)))return new r("Unexpected Identifier in EXPR",a)||V;if(u){if(u.type===x)return new r("Invalid EXPR",a)||V;if(u.type===z&&!u.val.match(/[.!\(\[]/))return new r("Invalid EXPR",a)||V}}else if(a.type===I&&u&&(u.type!==z||!u.val.match(/[\[\(]/)))return new r("Unexpected string literal",a)||V}if(f.length>0)return new r("Unbalanced EXPR",e)||V}function d(e){if(!e.def||e.def.length!==5)return new r("Expected range literal",e)||V;if(e.def[1].type!==x||!e.def[1].val.match(/^-?\d+$/))return new r("Invalid range literal",e.def[1])||V;if(e.def[3].type!==x||!e.def[3].val.match(/^-?\d+$/))return new r("Invalid range literal",e.def[3])||V;if(e.def[2].type!==z||e.def[2].val!=="..")return new r("Invalid range literal",e.def[2])||V}function v(e){var t,n,i,s;if(!(e.def&&e.def.length>=5))return new r("Expected set literal",e)||V;for(t=1;t<e.def.length-1;t++){i=s,s=e.def[t];if(s.type===I){if(i&&(i.type!==z||i.val!==","))return new r("Invalid set literal",s)||V}else{if(s.type!==z||s.val!==",")return new r("Invalid set literal",s)||V;if(!i||i.type!==I)return new r("Invalid set literal",s)||V}}if(e.def[e.def.length-2].type!==I)return new r("Invalid set literal",e.def[e.def.length-2])||V}function m(e){var t,o,u,c,h,p,m=[],b,w;if(!(e.def&&e.def.length>0))return new r("Expected assignment statement",e)||V;for(t=0;t<e.def.length;t++){if(e.def[t].type===U)continue;u=c,c=e.def[t];if(!!b){h=f(e.def.slice(t));if(h.length===0)return new r("Expected EXPR",c)||V;w=new n({parent:e,type:B,token:h[0].token,def:[]}),p=s(h);if(!p){w.def=h,S=g(w);if(S)return S}else w.def=[p];for(o=0;o<w.def.length;o++)w.def[o].parent=w;break}if(c.type===z)if(c.val==="="){b=new n({parent:e,type:H,token:m[0].token,def:m});if(!m[0]||m[0].type!==H||!m[1]||m[1].type!==R&&m[1].type!==q){S=y(b);if(S)return S}for(o=0;o<b.def.length;o++)b.def[o].parent=b;m=[]}else if(c.val==="["){h=i(e.def.slice(t));if(h){p=new n({parent:null,type:H,token:e.def[0].token,def:e.def.slice(0,t)}),S=y(p),S||(m=[p],p=new n({parent:null,type:q,token:c.token,def:h}),S=d(p),S&&(p.type=R,S=v(p)),S?S=new r("Invalid bracket literal",c)||V:(m.push(p),t+=h.length-1,l(p.def)));if(S)return S}else m.push(c)}else{if(!u||!c.val.match(/[.\[\]]/))return new r("Invalid statement EXPR",c)||V;m.push(c)}else m.push(c)}if(!b||!w)return new r("Invalid assignment statement",e)||V;b.def=a(b.def),w.def=a(w.def),e.def=[b,w],e.type=P}function g(e){var n,i,s,o=!1;if(!(e.def&&e.def.length>0))return new r("Expected EXPR",e)||V;for(n=0;n<e.def.length;n++){i=e.def[n];if(i.type===z){if(i.val==="!")return new t.tokenizer.TokenizerError("Unexpected token",i.token)||V}else if(i.type===x)if(!i.val.match(/^\d+$/))o=!0;else if(!o)return new r("Unexpected number",i)||V}s=p(e);if(s)return s}function y(e){var t,n,i,s;if(!(e.def&&e.def.length>0))return new r("Expected EXPR",e)||V;for(t=0;t<e.def.length;t++){if(e.def[t].type===U)continue;n=i,i=e.def[t];if(i.type===I&&(!n||n.type!==z||n.val!=="["))return new r("Unexpected string literal",i)||V}s=g(e);if(s)return s}var b,w,E,S,O,W;if(e.type===T){if(!e.id||!(b=c(e.id)))throw new r("Expected collection ID for Extend Tag",e)||V;e.id=b;if(e.def&&e.def.length){e.def[0]=e.id;if(e.def.length>1){for(W=1;W<e.def.length;W++)if(e.def[W].type!==U)throw new r("Unexpected",e.def[W])||V;e.def=[e.id]}}return e}if(e.type===N){if(!e.id||!(b=c(e.id)))throw new r("Expected #id for Tag",e)||V;e.id=b;if(e.def&&e.def.length){b=[e.id],E=a(e.def.slice(1));for(W=0;W<E.length;W++)w=c(E[W]),w&&b.push(w);e.def=b}if(e.children&&e.children.length){e.children=o(e.children),b=[];for(W=0;W<e.children.length;W++)w=c(e.children[W]),w&&b.push(w);e.children=o(b)}return e}if(e.type===L){if(!e.main_expr||!(b=c(e.main_expr)))throw new r("Expected EXPR for Tag",e)||V;e.main_expr=b;if(e.def&&e.def.length){b=[e.main_expr],E=a(e.def.slice(1));for(W=0;W<E.length;W++)w=c(E[W]),w&&b.push(w);e.def=b}if(e.children&&e.children.length){e.children=o(e.children),b=[];for(W=0;W<e.children.length;W++)w=c(e.children[W]),w&&b.push(w);e.children=o(b)}return e}if(e.type===k){if(!e.main_expr||!(b=c(e.main_expr)))throw new r("Expected EXPR for Tag",e)||V;e.main_expr=b;if(e.def&&e.def.length){if(e.def.length>1)for(W=1;W<e.def.length;W++)if(e.def[W].type!==U)throw new r("Unexpected",e.def[W])||V;e.def=[e.main_expr]}return e}if(e.type===C){if(!e.main_expr||!(b=c(e.main_expr)))throw new r("Expected template reference EXPR for Tag",e)||V;e.main_expr=b,e.context_expr.type=H,e.context_expr.def=a(e.context_expr.def),S=y(e.context_expr);if(S)throw S;return e.def=[e.main_expr,e.context_expr],e}if(e.type===A)return e.type=x,e;if(e.type===M){if(S=h(e))throw S;return e}if(e.type===D){if(!e.def||!e.def.length)throw new r("Expected EXPR",e)||V;e.def=u(e.def),e.def=a(e.def),S=m(e);if(S)throw S;return e}if(e.type===_){if(!e.def||!e.def.length)throw new r("Expected EXPR",e)||V;b=[];for(W=0;W<e.def.length;W++)e.def[W].type!==U&&b.push(e.def[W]);e.def=f(b);if((b=i(e.def))&&b.length===e.def.length){b=new n({parent:e,type:null,token:e.token,def:b});for(W=0;W<b.def.length;W++)b.def[W].parent=b;S=d(e),S?(S=v(e),S||(b.type=R)):b.type=q;if(S)throw new r("Invalid bracket literal",e)||V;l(b.def),e.def=[b]}else e.parent.type===k||e.parent.type===L?S=y(e):e.parent.type===C&&(S=g(e));if(S)throw S;return e}if(e.type===I)return e;if(e.type!==x)return e;if(e.val!=="")return e}function h(){var e;while(m<p.length&&!e&&p[m].complete)e=c(p[m++]);return e}n.prototype.toString=function(){function t(e){return e.delimiter+e.val+e.delimiter}function n(e){var t,n="";for(var t=0;t<e.def.length;t++)n+=e.def[t].toString();return n}function r(e){var t,n="";for(var t=0;t<e.children.length;t++)n+=e.children[t].toString();return n}var i,s,o;if(this.type===N)s="{$: ",this.id&&(s+=this.id.toString().replace(/(["']).*#/,"$1#")),s+=" }";else if(this.type===T)s="{$+ ",this.id&&(s+=this.id.toString()),s+=" $}";else if(this.type===C)s="{$= @",this.main_expr&&(s+=this.main_expr.toString(),o=this.context_expr.toString(),o!=="$"&&(s+=" | "+o)),s+=" $}";else if(this.type===k)s="{$= ",this.main_expr&&(s+=this.main_expr.toString()),s+=" $}";else if(this.type===L)s="{$* ",this.main_expr&&(s+=this.main_expr.toString()),s+=" }";else if(this.type===A)s="{$% "+r(this)+" %$}";else if(this.type===D||this.type===_)s=n(this);else if(this.type===P)s=this.def[0].toString()+" = "+this.def[1].toString();else if(this.type===j)s=this.def[0].toString()+" ? "+this.def[1].toString()+" : "+this.def[2].toString();else if(this.type===F||this.type===H||this.type===B)s=n(this);else if(this.type===I||this.type===M)s=t(this);else if(this.type===q)s="["+this.def[0].val+".."+this.def[1].val+"]";else if(this.type===R){s="";for(i=0;i<this.def.length;i++)s+=(s!==""?",":"")+t(this.def[i]);s="["+s+"]"}else this.type===x||this.type===z?s=this.val:this.type===U?s=" ":s=JSON.stringify(this);return s};var r=function(){function r(){}function i(e,t){var n=this===global?new r:this;return n.message=e,n.ref=t,n}return r.prototype=i.prototype=Object.create(SyntaxError.prototype),i.prototype.constructor=i,i.prototype.toString=function(){var r="",i,s;return this.ref&&(this.ref instanceof t.tokenizer.Token?r="; "+this.ref.toString():this.ref instanceof n?(this.ref.token?(i=this.ref.token.pos,(this.ref.type===I||this.ref.type===M)&&i--,i="position: "+i+"; "):i="",s=this.ref.toString(),s!==""&&(this.ref.type!==I&&this.ref.type!==M&&(s="`"+s+"`"),s+="; "),r="; "+s+i+"node-type: "+this.ref.type):r="; "+this.ref),"ParserError: "+this.message+r},i}(),p=[],d,v="",m=0,g=0,y=1,b=2,w=3,E=4,S=5,x=0,T=1,N=2,C=3,k=4,L=5,A=6,O=7,M=8,_=9,D=10,P=11,H=12,B=13,j=14,F=15,I=16,q=17,R=18,U=19,z=20,W=21,X,V=new Error("Unknown error");X={OUTSIDE:g,INSIDE:y,RAW:b,COMMENT:w,LITERAL:E,INVALID:S,TEXT:x,TAG_EXTEND:T,TAG_DEFINE:N,TAG_INCL_TMPL:C,TAG_INCL_VAR:k,TAG_LOOP:L,TAG_RAW:A,TAG_COMMENT:O,ID:M,MAIN_REF_EXPR:_,GENERAL_EXPR:D,ASSIGNMENT_EXPR:P,REF_EXPR:H,VAL_EXPR:B,CONDITIONAL_EXPR:j,BOOLEAN_EXPR:F,STRING_LITERAL:I,RANGE_LITERAL:q,SET_LITERAL:R,WHITESPACE:U,OPERATOR:z,COLLECTION_MARKER:W,state:g,nodify:i,end:s,parseNextNode:h,ParserError:r,Node:n},t.parser=X}(this.grips),function(t){function n(e){return e.replace(/\\([\s\S])|(")/g,"\\$1$2")}function r(e){return e.replace(/\n/g,"\\n").replace(/\r/g,"\\r")}function i(e){return e.replace(/\\(?!\\*\")/g,"\\\\")}function s(e){var n;return n={type:e.type,pos:null,val:e.toString()},e.type===t.parser.ID&&e.token&&e.token.val&&(n.val=e.token.val),e.token&&(n.pos=e.token.pos),JSON.stringify(n)}function o(e){return e=e.replace(/[^a-z0-9_$]/ig,"_"),e}function u(e){var t="";return t+="(function __"+o(e.start)+"__"+"(G){ ",t+="function __sort_fn__(a,b){ return a-b; } ",t+="var partial = G.definePartial, clone = G.cloneObj, extend = G.extend, ",t+="error = G.error, ",t+="RLH = G.RangeLiteralHash, ",t+='cID = "'+e.start+'"; ',t}function a(e){return"})(this.grips); "}function f(e){return p(e.def[0])+" ? "+p(e.def[1])+" : "+p(e.def[2])}function l(e){return e.delimiter+e.val+e.delimiter}function c(e){var t="";return t+="for (i="+e.def[0].val+"; i",e.def[0].val<=e.def[1].val?t+="<="+e.def[1].val+"; i++) { ":t+=">="+e.def[1].val+"; i--) { ",t}function h(e){var t,n="",r,i;i="";for(t=0;t<e.def.length;t++)r=e.def[t],i+=(i!==""?",":"")+l(r);return n+="var _set = ["+i+"]; ",n+="for (i=0; i<"+e.def.length+"; i++) { ",n}function p(e){var n,r="",i,s;if(e.type===t.parser.STRING_LITERAL||e.type===t.parser.ID)r+=l(e);else{if(!(e.def&&e.def.length>0))throw new t.parser.ParserError("Invalid EXPR",e)||N;if(e.def[0].type===t.parser.CONDITIONAL_EXPR)r+=f(e.def[0]);else for(n=0;n<e.def.length;n++)s=i,i=e.def[n],i.type===t.parser.TEXT?(i.val.match(/^\d+$/)||i.val.match(/^[_\$](?=(?:[^a-z0-9_$]|$))/i)||s&&s.type===t.parser.OPERATOR&&s.val==="."||(r+="$$."),r+=i.val):i.type===t.parser.OPERATOR?r+=i.val:i.type===t.parser.STRING_LITERAL&&(r+=l(i))}return r}function d(e){var t="",n,r;return n=e.def[0],r=p(n.def[0]),t+=r+" = new RLH(); ",t+=c(n.def[1]),n=e.def[1].def[0],t+=r+'["" + i] = ('+p(n.def[0])+" === i) ? ",t+=p(n.def[1])+" : "+p(n.def[2])+"; ",t+="} ",t}function v(e){var t="",n,r;return n=e.def[0],r=p(n.def[0]),t+=r+" = {}; ",t+=h(n.def[1]),n=e.def[1].def[0],t+=r+"[_set[i]] = ("+p(n.def[0])+" === _set[i]) ? ",t+=p(n.def[1])+" : "+p(n.def[2])+"; ",t+="} ",t}function m(e){var n="",r;return r=e.def[0],r.def[r.def.length-1].type===t.parser.RANGE_LITERAL?n+=d(e):r.def[r.def.length-1].type===t.parser.SET_LITERAL?n+=v(e):(n+=p(r),n+=" = ",n+=p(e.def[1]),n+="; "),n}function g(e){return'extend(cID,"'+e.id.val+'"); '}function y(e){var t,n="",r;n+="partial(function __"+o(e.id.val.replace(/^.*#/,""))+"__"+"($,$$){ ",n+="$ = clone($) || {}; ",n+="$$ = clone($$) || {}; ",n+='var i, ret = "", ret2, _; ';for(t=1;t<e.def.length;t++)r=e.def[t],n+="try { ",n+=m(r),n+="} catch (err"+t+") { ",n+="return error(cID,"+s(r)+',"Assignment failed",err'+t+"); ",n+="} ";return n+=S(e),n+="return ret; ",n+='},"'+e.id.val+'"',n+=","+s(e),n+="); ",n}function b(e){var n,r="",i,o;r+="ret2 = (function __loop__ ($,$$,_){ ",r+="function __iter__($,$$,value,key,index){ ",r+='var i, ret = "", ret2, _; ',r+="if (value == null) return ret; ",r+="$ = clone($); ",r+="$$ = clone($$); ",r+="_ = { ",r+="value: value, ",r+="key: key, ",r+="index: index, ",r+="even: (index % 2) === 0, ",r+="odd: (index % 2) === 1, ",r+="first: (index === 0), ",r+="last: (index === len - 1) ",r+="}; ";for(n=1;n<e.def.length;n++)i=e.def[n],r+="try { ",r+=m(i),r+="} catch (err"+n+") { ",r+="return error(cID,"+s(i)+',"Assignment failed in loop iteration: " + JSON.stringify(_,["key","index"]),err'+n+"); ",r+="} ";return r+=S(e),r+="return ret; ",r+="} ",r+='var i, j = 0, len, ret = "", it, tmp; ',r+="try { ",e.main_expr.def[0].type===t.parser.SET_LITERAL?(r+=h(e.main_expr.def[0]),r+="len = _set.length; ",r+='ret2 = __iter__($,$$,_set[i],""+i,i); ',r+=x("ret","ret2"),r+="} "):e.main_expr.def[0].type===t.parser.RANGE_LITERAL?(r+="len = "+(Math.abs(e.main_expr.def[0].def[0].val-e.main_expr.def[0].def[1].val)+1)+"; ",r+=c(e.main_expr.def[0]),r+='ret2 = __iter__($,$$,i,""+i,j++); ',r+=x("ret","ret2"),r+="} "):(r+="it = "+p(e.main_expr)+"; ",r+="if (it == null) { ",r+='return ""; ',r+="} ",r+='if (Object.prototype.toString.call(it) === "[object Array]") { ',r+="len = it.length; ",r+="for (i=0; i<len; i++) { ",r+='ret2 = __iter__($,$$,it[i],""+i,i); ',r+=x("ret","ret2"),r+="} ",r+='} else if (typeof it === "object") { ',r+="tmp = Object.keys(it); ",r+="len = tmp.length; ",r+="if (it instanceof RLH) { ",r+="tmp.sort(__sort_fn__); ",r+="for (i=0; i<len; i++) { ",r+="ret2 = __iter__($,$$,it[tmp[i]],tmp[i],i); ",r+=x("ret","ret2"),r+="} ",r+="} else { ",r+="for (i in it) { if (it.hasOwnProperty(i)) { ",r+="ret2 = __iter__($,$$,it[i],i,j++); ",r+=x("ret","ret2"),r+="}} ",r+="} ",r+="} else { ",r+="return ",r+="error(cID,"+s(e.main_expr)+',"Invalid loop-iterator reference") || ',r+='new Error("Unknown error"); ',r+="} "),r+="} catch (err) { ",r+="return error(cID,"+s(e.main_expr)+',"Failed loop iteration",err); ',r+="} ",r+="return ret; ",r+="})(clone($),clone($$),clone(_)); ",r+=x("ret","ret2"),r}function w(e){var t="",n;return n=p(e.context_expr),t+="try { ",t+="ret2 = "+n+"; ",t+="} catch (err) { ",t+="return error(cID,"+s(e.context_expr)+',"Include template context reference failed",err); ',t+="} ",t+="try { ",t+="ret2 = G.render("+p(e.main_expr)+",ret2,$$); ",n=s(e.main_expr),t+="} catch (err) { ",t+="if (err instanceof G.TemplateError) { ",t+="err.ref = "+n+"; ",t+="return err; ",t+="} else { ",t+="return error(cID,"+n+',"Include template reference failed",err); ',t+="} ",t+="} ",t+=x("ret","ret2"),t}function E(e){var t="";return t+="try { ",t+="ret += "+p(e.main_expr)+"; ",t+="} catch (err) { ",t+="return error(cID,"+s(e.main_expr)+',"Include reference failed",err); ',t+="} ",t}function S(e){var s,o="",u;for(s=0;s<e.children.length;s++)u=e.children[s],u.type===t.parser.TEXT?o+='ret += "'+r(i(n(u.val)))+'"; ':u.type===t.parser.TAG_LOOP?o+=b(u):u.type===t.parser.TAG_INCL_TMPL?o+=w(u):u.type===t.parser.TAG_INCL_VAR&&(o+=E(u));return o}function x(e,t){var n="";return n+="if ("+t+" instanceof G.TemplateError) { ",n+="return "+t+"; ",n+="} else { ",n+=e+" += "+t+"; ",n+="} ",n}function T(e){var n,r=[],i="",s="",o;while(n=t.parser.parseNextNode()){r.push(n);if(n.type===t.parser.COLLECTION_MARKER)n.start?(o=u(n),i+=o,s+=o):n.close&&(o=a(n),i+=o,s+=o,e&&t.initializeCollection(n.close,i),i="");else if(n.type===t.parser.TAG_EXTEND){if(!(r.length>1&&r[r.length-2].type===t.parser.COLLECTION_MARKER))throw new t.parser.ParserError("Unexpected Extend Tag",n)||N;o=g(n),i+=o,s+=o}else n.type===t.parser.TAG_DEFINE&&(o=y(n),i+=o,s+=o)}return s}var N=new Error("Unknown error");t.generator={process:T}}(this.grips);