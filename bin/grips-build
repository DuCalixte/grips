#!/usr/bin/env node

/* grips (c) 2012 Kyle Simpson | http://getify.mit-license.org/ */

function print_help() {
	console.log("build tool for grips templating engine");
	console.log("(c) 2012 Kyle Simpson | http://getify.mit-license.org/");
	console.log("");
	console.log("usage: grips-build [opt, ...]");
	console.log("");
	console.log("options:");
	console.log("--help       show this help");
	console.log("--verbose    display progress");
	console.log("--all        build all options (ignores --runtime and --nodebug)");
	console.log("--runtime    builds only the stripped down runtime (no compiler)");
	console.log("--amd        also build AMD style files (amd-*.js)");
	console.log("--node       build the node.js compatible package (in a /bin folder)");
	console.log("--nodebug    strip debug code (smaller files with less graceful error handling)");
	console.log("--minify     minify all built files with uglify.js (creates *.min.js files)");
	console.log("");
}

function minify(str) {
	var ast;
	ast = jsp.parse(str); // parse code and get the initial AST
	ast = pro.ast_mangle(ast); // get a new AST with mangled names
	ast = pro.ast_squeeze(ast); // get an AST with compression optimizations
	return ";" + pro.gen_code(ast) + ";"; // compressed code here
}

function node_ify(str) {
	var ret = "";

	ret += "(function __grips_node__(){\n";
	ret += str + "\n";
	ret += "}).call(exports);";

	return ret;
}

function amd_ify(str) {}


var path = require("path"),
	fs = require("fs"),

	DIR_LIB = path.join(__dirname,"..","lib"),
	DIR_DEPLOY = path.join(__dirname,"..","deploy"),
	DIR_ROOT = path.join(__dirname,".."),

	FILE_FULL_DEBUG = path.join(DIR_DEPLOY,"grips-full.debug.js"),
	FILE_FULL = path.join(DIR_DEPLOY,"grips-full.js"),
	FILE_RUNTIME_DEBUG = path.join(DIR_DEPLOY,"grips.debug.js"),
	FILE_RUNTIME = path.join(DIR_DEPLOY,"grips.js"),
	FILE_NODE_DEBUG = path.join(DIR_ROOT,"node-grips-debug.js"),
	FILE_NODE = path.join(DIR_ROOT,"node-grips.js"),

	FILE_AMD_PREFIX = "amd-",

	OPT_BUILD_EVERYTHING = false,
	OPT_BUILD_RUNTIME_ONLY = false,
	OPT_AMD = false,
	OPT_NODE = true,
	OPT_STRIP_DEBUG = false,
	OPT_MINIFY = false,
	OPT_VERBOSE = false,

	FILE_CONTENTS = "",
	STRIP_BUILD_TAGS = /\/\* ST(?:ART|OP)_(?:DEBUG|COMPILER) \*\//g,
	STRIP_COMPILER = /\/\* START_COMPILER[\s\S]*?STOP_COMPILER \*\//g,
	STRIP_DEBUG = /\/\* START_DEBUG[\s\S]*?STOP_DEBUG \*\//g,

	HEADER_STAMP = "/* grips (c) 2012 Kyle Simpson | http://getify.mit-license.org/ */\n",
	HEADER_REGEX = /\/\* grips \(c\).*?\*\//gi,

	content,
	tmp,

	// for uglify, if desired
	jsp,
	pro
;

process.argv.slice(2).forEach(function(arg){
	switch (arg) {
		case "--help":
			print_help();
			process.exit(1);
			break;
		case "--all":
			OPT_BUILD_EVERYTHING = true;
			OPT_BUILD_RUNTIME_ONLY = false;
			OPT_STRIP_DEBUG = true;
			break;
		case "--runtime":
			if (!OPT_BUILD_EVERYTHING) {
				OPT_BUILD_RUNTIME_ONLY = true;
			}
			break;
		case "--amd":
			OPT_AMD = true;
			break;
		case "--node":
			OPT_NODE = true;
			break;
		case "--nodebug":
			OPT_STRIP_DEBUG = true;
			break;
		case "--minify":
			OPT_MINIFY = true;
			try {
				jsp = require("uglify-js").parser;
				pro = require("uglify-js").uglify;
			}
			catch (err) {
				console.log("--minify failed because 'uglify-js' module is missing or invalid.");
				console.log("");
				print_help();
				process.exit(1);
				break;
			}
			break;
		case "--verbose":
			OPT_VERBOSE = true;
			break;
		default:
			console.log("Unrecognized flag: " + arg);
			console.log("");
			print_help();
			process.exit(1);
			break;
	}
});

["base.js","tokenizer.js","parser.js","generator.js"].forEach(function(filename){
	FILE_CONTENTS += ";" + fs.readFileSync(path.join(DIR_LIB,filename),"utf8");
});

HEADER_REGEX.lastIndex = 0; // reset regex to fix wonky regex caching bug
FILE_CONTENTS = FILE_CONTENTS.replace(HEADER_REGEX,"");

if (!fs.existsSync(DIR_DEPLOY)) {
	fs.mkdirSync(DIR_DEPLOY);
}
if (OPT_NODE && !fs.existsSync(DIR_ROOT)) {
	fs.mkdirSync(DIR_ROOT);
}

if (!OPT_BUILD_RUNTIME_ONLY) {
	if (OPT_STRIP_DEBUG) {
		if (OPT_VERBOSE) console.log("Building:  " + FILE_FULL);
		content = FILE_CONTENTS.replace(STRIP_DEBUG,"").replace(STRIP_BUILD_TAGS,"");
		fs.writeFileSync(FILE_FULL,HEADER_STAMP + content,"utf8");

		if (OPT_MINIFY) {
			if (OPT_VERBOSE) console.log("Minifying: " + FILE_FULL.replace(/\.js$/,".min.js"));
			fs.writeFileSync(FILE_FULL.replace(/\.js$/,".min.js"),HEADER_STAMP + minify(content),"utf8");
		}
	}

	if (!OPT_STRIP_DEBUG || OPT_BUILD_EVERYTHING) {
		if (OPT_VERBOSE) console.log("Building:  " + FILE_FULL_DEBUG);
		content = FILE_CONTENTS.replace(STRIP_BUILD_TAGS,"");
		fs.writeFileSync(FILE_FULL_DEBUG,HEADER_STAMP + content,"utf8");

		if (OPT_MINIFY) {
			if (OPT_VERBOSE) console.log("Minifying: " + FILE_FULL_DEBUG.replace(/\.js$/,".min.js"));
			fs.writeFileSync(FILE_FULL_DEBUG.replace(/\.js$/,".min.js"),HEADER_STAMP + minify(content),"utf8");
		}
	}
}

if (OPT_NODE || OPT_BUILD_EVERYTHING) {
	if (OPT_STRIP_DEBUG) {
		if (OPT_VERBOSE) console.log("Building:  " + FILE_NODE);
		content = FILE_CONTENTS.replace(STRIP_DEBUG,"").replace(STRIP_BUILD_TAGS,"");
		fs.writeFileSync(FILE_NODE,HEADER_STAMP + node_ify(content),"utf8");
	}

	if (OPT_VERBOSE) console.log("Building:  " + FILE_NODE_DEBUG);
	content = FILE_CONTENTS.replace(STRIP_BUILD_TAGS,"");
	fs.writeFileSync(FILE_NODE_DEBUG,HEADER_STAMP + node_ify(content),"utf8");
}

if (OPT_STRIP_DEBUG) {
	if (OPT_VERBOSE) console.log("Building:  " + FILE_RUNTIME);
	content = FILE_CONTENTS.replace(STRIP_COMPILER,"").replace(STRIP_DEBUG,"");
	fs.writeFileSync(FILE_RUNTIME,HEADER_STAMP + content,"utf8");

	if (OPT_MINIFY) {
		if (OPT_VERBOSE) console.log("Minifying: " + FILE_RUNTIME.replace(/\.js$/,".min.js"));
		fs.writeFileSync(FILE_RUNTIME.replace(/\.js$/,".min.js"),HEADER_STAMP + minify(content),"utf8");
	}
}

if (!OPT_STRIP_DEBUG || OPT_BUILD_EVERYTHING) {
	if (OPT_VERBOSE) console.log("Building:  " + FILE_RUNTIME_DEBUG);
	content = FILE_CONTENTS.replace(STRIP_COMPILER,"").replace(STRIP_BUILD_TAGS,"");
	fs.writeFileSync(FILE_RUNTIME_DEBUG,HEADER_STAMP + content,"utf8");

	if (OPT_MINIFY) {
		if (OPT_VERBOSE) console.log("Minifying: " + FILE_RUNTIME_DEBUG.replace(/\.js$/,".min.js"));
		fs.writeFileSync(FILE_RUNTIME_DEBUG.replace(/\.js$/,".min.js"),HEADER_STAMP + minify(content),"utf8");
	}
}

if (OPT_VERBOSE) console.log("Build complete.");
